<!doctype html><html lang=zh-tw><head><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-100004441-1','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>我的第一個Online Judge &#183; Imaginary City</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/custom.css><link rel=icon href=favicon.ico><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title="Imaginary City"></head><body><nav class=nav><div class=nav-container><a href=/><h2 class=nav-title>Imaginary City</h2></a><ul><li><a href=/about/><span>About</span></a></li><li><a href=/notes/><span>Notes</span></a></li><li><a href=/oj/><span>OJ</span></a></li><li><a href=/posts/><span>Posts</span></a></li><li><a href=/tags/><span>Tags</span></a></li></ul></div></nav><main><div class=post><div class=post-info><br><time datetime="2014-11-01 08:00:00 +0000 UTC">November 1, 2014</time></div><h1 class=post-title>我的第一個Online Judge</h1><div class=post-line></div><p>是這樣的，在開學期間左右，培訓班的助教要我們每隊生出三題，
生完題目後照理應該是OK了，可是我覺得還沒有，因為我突然想要開始寫Online Judge XDD
不過當時倒是還沒有去實踐，因為如何製作Online Judge，對我來說完全沒有概念</p><p>於是，我去翻了一些資料，像是</p><h2 id=sqlite3>Sqlite3</h2><p>因為是第一個Online Judge，所以打算只先實驗性的用他來當作資料庫
這是之前試的: Sqlite in C</p><h2 id=執行安全性>執行安全性</h2><p>這是最重要的一塊，前端的server其次，judge端的安全性最為重要，
因為別人會丟他們自己的code，在系統裡執行。</p><p>這一部分我是去翻這:
<a href=http://www.zhihu.com/question/23067497>Online Judge 是如何解决判题端安全性问题的？</a></p><p>這裡面大概有些不錯的方法，像是沙盒之類。</p><h2 id=其他oj>其他OJ</h2><ul><li><a href=https://github.com/joshua5201/tioj>TIOJ</a></li><li><a href=https://github.com/pzread/judge>pzread的judge</a></li></ul><p>大概看了一些OJ的實作後，便開始著手寫judge端了!!
光是流程就有點多:
(以下步驟基本上沒有考慮到效率，基本上目標是功能性。)</p><ol><li>從資料庫讀取尚未處理的Submit的第一筆(其實這會讓Judge表現的像Stack)</li><li>把程式碼和測試資料(只有in)拷貝到測試區域</li><li><code>fork</code> 執行程式，parent用while做限時功能</li><li>比對 test.out 和 正確的out</li><li>將結果寫回資料庫</li></ol><p>然後前端是用<code>python</code>的<code>tornado</code>寫，輸入資料基本上只擋長度，SQL指令用參數式，基本上不會有SQL Injection問題。</p><p>這只能說是把流程寫好，但最重要的judge端安全還沒寫</p><p>所以去找了幾個Sandbox，然後發現這應該頗好操作</p><h2 id=easysandbox>EasySandbox</h2><ul><li><a href=https://github.com/daveho/EasySandbox>EasySandbox</a></li><li><a href=http://justanothergeek.chdir.org/2010/03/seccomp-as-sandboxing-solution/>SECCOMP as a Sandboxing Solution ?</a></li></ul><p>主要用<code>prctl</code> + <code>LD_PRELOAD</code>做成</p><ol><li>只有辦法做<code>read</code>, <code>write</code>, <code>sigreturn</code>, <code>_exit</code> Syscall</li><li>有實作<code>malloc</code>和<code>free</code></li></ol><p>看了一下他的Code，一開始的輸出</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&lt;&lt;entering SECCOMP mode&gt;&gt;
</span></span></code></pre></td></tr></table></div></div><p>似乎無法避免，不過這不成問題</p><p>要讓程式在Sandbox裡跑，基本上只要寫</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#00688b;font-weight:700>char</span>* argv[] = {<span style=color:#cd5555>&#34;./t123.out&#34;</span>, (<span style=color:#00688b;font-weight:700>char</span>*)<span style=color:#b452cd>0</span>};
</span></span><span style=display:flex><span><span style=color:#00688b;font-weight:700>char</span>* envs[] = {<span style=color:#cd5555>&#34;LD_PRELOAD=./EasySandbox.so&#34;</span>, (<span style=color:#00688b;font-weight:700>char</span>*)<span style=color:#b452cd>0</span>};
</span></span><span style=display:flex><span>execve(<span style=color:#cd5555>&#34;./t123.out&#34;</span>, argv, envs);
</span></span></code></pre></td></tr></table></div></div><p>加個<code>chroot</code>就頗ok惹</p><h2 id=compiler-tle>Compiler TLE</h2><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#1e889b>#include</span><span style=color:#1e889b>&#34;/dev/random&#34;</span><span style=color:#1e889b>
</span></span></span></code></pre></td></tr></table></div></div><p>需要對編譯器做限時，要不然就等著Judge呵呵吧XD</p><p>把這些完成後，就是:</p><p><a href=https://bitbucket.org/mudream/usoj>Unsafe Online Judge</a></p><p>這大概只能算是第一階段。</p><hr><script src=https://utteranc.es/client.js repo=mudream4869/imgcity-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div class=pagination><a href=/posts/2014/09-22-sqlite-in-c/ class="left arrow">&#8592;Sqlite3 in C</a>
<a href=/posts/2014/11-03-count-on-totient-function/ class="right arrow">Count on Totient Function&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2022-05-31 13:41:25.890193789 +0000 UTC m=+0.065377450">2022</time> Mudream. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>