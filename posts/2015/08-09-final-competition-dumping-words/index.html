<!doctype html><html lang=zh-tw><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-05CDSVM4JL"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-05CDSVM4JL",{anonymize_ip:!1})}</script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>期末廢文大賽排行榜製作 &#183; Imaginary City</title>
<link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/custom.css><link rel=icon href=favicon.ico><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title="Imaginary City"></head><body><nav class=nav><div class=nav-container><a href=/><h2 class=nav-title>Imaginary City</h2></a><ul><li><a href=/about/><span>About</span></a></li><li><a href=https://blog.mukyu.tw/note-of-code/><span>Notes</span></a></li><li><a href=/oj/><span>OJ</span></a></li><li><a href=/posts/><span>Posts</span></a></li><li><a href=/tags/><span>Tags</span></a></li></ul></div></nav><main><div class=post><div class=post-info><br><time datetime="2015-08-09 08:00:00 +0000 UTC">August 9, 2015</time></div><h1 class=post-title>期末廢文大賽排行榜製作</h1><p style=text-align:center><a href=/tags/python>#Python</a></p><div class=post-line></div><h2 id=原因>原因</h2><p>一開始是在期末窮極無聊的時候發起了一個活動<a href=https://www.facebook.com/events/832004440226215/>期末廢文大賽</a>，然後四五天過後，發文人數意外的多，還有幾篇讚數也快突破天際了 <del>看來大家的期末都好崩潰</del> ，就有點好奇哪些貼文讚數前十名。</p><h2 id=實作>實作</h2><p>基本上，主要是使用<a href=https://developers.facebook.com/docs/graph-api>Facebook Graph API</a>，需要和Facebook申請成為Developer後，再申請一個App(這樣就可以獲得操作API的<strong>access_token</strong>)</p><p>拿到操作API的Token後，試了一下抓取活動貼文的API，大概可以發現：</p><ul><li>每次回傳十個貼文的相關資訊和<strong>下一頁</strong></li><li>貼文的相關資訊不包含讚數（需要自行抓取）</li><li>一頁的貼文數量雖然可以調整，但不能太多</li></ul><p>所以就必須分批抓取，並且讚數也要額外抓取。實際弄一弄會發現每次更新記分板總共至少超過5分鐘，所以Server這樣是設計的:：首先寫一個可以自動生成靜態網頁排行榜的<code>Python</code>腳本，然後讓系統每固定時間去執行即可。</p><h3 id=固定執行>固定執行</h3><p>Linux提供了一個很方便的排程系統<code>Crontab</code>，只要指定好觸發規律（可能每天哪個時段或每小時哪些分鐘之類，總之很方便。）和執行指令，就好了。</p><h3 id=腳本>腳本</h3><p>用到Python的<code>Request</code>和<code>Tornado</code>。</p><ul><li>不斷地抓取貼文，直到沒有下一頁：</li></ul><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>it_url = 貼文API
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>while</span>(<span style=color:#b452cd>1</span>):
</span></span><span style=display:flex><span>    obj = json.loads(requests.get(it_url).text)
</span></span><span style=display:flex><span>    <span style=color:#8b008b;font-weight:700>for</span> row <span style=color:#8b008b>in</span> obj[<span style=color:#cd5555>&#34;data&#34;</span>]:
</span></span><span style=display:flex><span>        <span style=color:#cd5555>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#cd5555>        貼文ID : row[&#34;id&#34;]
</span></span></span><span style=display:flex><span><span style=color:#cd5555>        貼文時間 : row[&#34;created_time&#34;]
</span></span></span><span style=display:flex><span><span style=color:#cd5555>        貼文內容 : row[&#34;message&#34;]
</span></span></span><span style=display:flex><span><span style=color:#cd5555>        &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b008b;font-weight:700>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b008b;font-weight:700>if</span> <span style=color:#cd5555>&#34;paging&#34;</span> <span style=color:#8b008b>not</span> <span style=color:#8b008b>in</span> obj: <span style=color:#8b008b;font-weight:700>break</span>
</span></span><span style=display:flex><span>    <span style=color:#8b008b;font-weight:700>if</span> <span style=color:#cd5555>&#34;next&#34;</span> <span style=color:#8b008b>not</span> <span style=color:#8b008b>in</span> obj[<span style=color:#cd5555>&#34;paging&#34;</span>]: <span style=color:#8b008b;font-weight:700>break</span>
</span></span><span style=display:flex><span>    it_url = obj[<span style=color:#cd5555>&#34;paging&#34;</span>][<span style=color:#cd5555>&#34;next&#34;</span>]
</span></span></code></pre></td></tr></table></div></div><ul><li>抓取讚數：</li></ul><p>需要貼文的ID，然後因為一些特殊貼文似乎沒有summary，所以擋一下Exception</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7>7</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>base_url = <span style=color:#cd5555>&#34;https://graph.facebook.com/v2.3/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>def</span> <span style=color:#008b45>get_like_count</span>(<span style=color:#658b00>id</span>):
</span></span><span style=display:flex><span>    get_obj = json.loads(requests.get(base_url + <span style=color:#658b00>id</span> + <span style=color:#cd5555>&#34;/likes?summary=true&amp;&#34;</span> + access_token).text)
</span></span><span style=display:flex><span>    <span style=color:#8b008b;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#8b008b;font-weight:700>return</span> get_obj[<span style=color:#cd5555>&#34;summary&#34;</span>][<span style=color:#cd5555>&#34;total_count&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#8b008b;font-weight:700>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#b452cd>0</span>
</span></span></code></pre></td></tr></table></div></div><p>然後網頁主要是用<code>Tornado</code>的Template生成來做到，這裏就不特別說明。</p><p>生成網頁的長這樣(2015/08/09抓的)</p><p><img src=result.png alt=Result></p><h3 id=完整code>完整Code</h3><p><a href=https://gist.github.com/mudream4869/b1a143d6c14f27cfd642>期末廢文大賽記分板Gist</a></p><h2 id=正確性>正確性</h2><p>因為並不是一次就把所有發文都抓到手，且每篇的讚數都是分別抓取，所以抓取的讚數會有點不正確。不過，實際上，在前十名的排名基本上不會有影響，因為前十名差距基本上都是百位起跳，所以排名是不會有影響的。</p><h2 id=後記>後記</h2><p>之後有為了另一個活動改成每半小時蒐集資料塞到一個資料庫，提供按照內文或貼文使用者搜尋的功能。手段大同小異，就不贅述。</p><hr><script src=https://utteranc.es/client.js repo=mudream4869/imgcity-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div class=pagination><a href=/posts/2015/08-05-acm-different-number-of-elements/ class="left arrow">&#8592;區間相異元素個數
</a><a href=/posts/2015/12-30-java-call-c-functions/ class="right arrow">Java 呼叫 c++ 函數&#8594;
</a><a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2023-12-21 14:24:39.737924557 +0000 UTC m=+0.226263624">2023</time> Mudream. Made with <a href=https://gohugo.io>Hugo</a> using the <a href=https://github.com/EmielH/tale-hugo/>Tale</a> theme.</span></footer></body></html>